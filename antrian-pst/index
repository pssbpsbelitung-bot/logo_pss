<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Antrian Kunjungan PST BPS Belitung</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter, Arial, sans-serif;
  background:#f8fafc;
  padding:24px;
  color:#111827;
}
.card{
  background:#fff;
  border-radius:18px;
  padding:20px;
  margin-bottom:20px;
  box-shadow:0 10px 24px rgba(0,0,0,.05);
}
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:16px;
}
.stat{border-left:6px solid #1d4ed8}
.stat.orange{border-color:#f97316}
.stat.green{border-color:#16a34a}
.stat h3{font-size:28px;margin:4px 0}

button{
  border:none;
  border-radius:10px;
  padding:10px 16px;
  font-size:14px;
  cursor:pointer;
  color:#fff;
}
.btn-green{background:#16a34a}
.btn-blue{background:#1d4ed8}
.btn-red{background:#ef4444}
.btn-small{padding:6px 12px;font-size:12px}

table{
  width:100%;
  border-collapse:collapse;
}
th,td{
  padding:10px;
  border-bottom:1px solid #e5e7eb;
}
th{
  font-size:12px;
  text-transform:uppercase;
  color:#6b7280;
  text-align:left;
}

.badge{
  padding:4px 10px;
  border-radius:20px;
  font-size:12px;
}
.wait{background:#fef3c7;color:#92400e}
.done{background:#dcfce7;color:#166534}

footer{
  text-align:center;
  font-size:12px;
  color:#6b7280;
  margin-top:20px;
}
</style>
</head>

<body>

<!-- HEADER + LOGO -->
<div style="display:flex;align-items:center;gap:14px;margin-bottom:16px">
  <img src="logo-bps.png" style="height:60px">
  <div>
    <h2 style="margin:0">Antrian Kunjungan PST</h2>
    <p style="margin:0;color:#6b7280">BPS Kabupaten Belitung</p>
  </div>
</div>

<!-- STAT -->
<div class="grid">
  <div class="card stat">
    <small>Total Hari Ini</small>
    <h3 id="total">0</h3>
  </div>
  <div class="card stat orange">
    <small>Menunggu</small>
    <h3 id="waiting">0</h3>
  </div>
  <div class="card stat green">
    <small>Selesai</small>
    <h3 id="done">0</h3>
  </div>
</div>

<!-- AMBIL ANTRIAN -->
<div class="card">
  <h3>Ambil Nomor Antrian</h3>
  <button class="btn-green" onclick="ambilAntrian()">ðŸŽ« Ambil & Cetak Tiket</button>
</div>

<!-- STATISTIK -->
<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <h3>ðŸ“Š Statistik Pengunjung Bulanan</h3>
    <button class="btn-blue" onclick="toggleStat()">Tampilkan</button>
  </div>

  <div id="statistikBox" style="display:none;margin-top:16px">
    <input type="month" id="filterBulan">
    <button class="btn-green" onclick="applyFilterBulanan()">Terapkan</button>
    <canvas id="chartPengunjung" height="120"></canvas>
  </div>
</div>

<!-- RIWAYAT -->
<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <h3>ðŸ“œ Riwayat Kunjungan</h3>
    <div>
      <button class="btn-red" onclick="resetTampilan()">Reset Tampilan</button>
      <button class="btn-red" onclick="resetDatabase()">Reset Database</button>
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th>No</th><th>Tanggal</th><th>Jam</th><th>Status</th><th>Aksi</th>
      </tr>
    </thead>
    <tbody id="log"></tbody>
  </table>
</div>

<footer>Â© PST BPS Kabupaten Belitung</footer>

<script>
let data = JSON.parse(localStorage.getItem("antrianPST")) || [];
let startViewDate = localStorage.getItem("startViewDate");
const today = new Date().toLocaleDateString("id-ID");

/* AMBIL ANTRIAN */
function ambilAntrian(){
  const no = data.filter(d=>d.tgl===today).length + 1;
  const tiket = {
    no:no,
    tgl:today,
    jam:new Date().toLocaleTimeString("id-ID"),
    status:"Menunggu"
  };
  data.push(tiket);
  localStorage.setItem("antrianPST", JSON.stringify(data));
  render();
  cetakTiket(tiket);
}

/* SELESAI */
function selesaikan(i){
  if(!confirm("Tandai antrian sebagai selesai?")) return;
  data[i].status="Selesai";
  localStorage.setItem("antrianPST", JSON.stringify(data));
  render();
}

/* RESET TAMPILAN */
function resetTampilan(){
  startViewDate = today;
  localStorage.setItem("startViewDate", startViewDate);
  render();
}

/* RESET DATABASE (PASSWORD) */
function resetDatabase(){
  const pwd = prompt("Masukkan password reset database:");
  if(pwd === null) return;
  if(pwd !== "resetantri"){
    alert("âŒ Password salah");
    return;
  }
  if(!confirm("âš ï¸ Yakin hapus SEMUA data?")) return;

  localStorage.clear();
  data=[];
  if(window.chart) window.chart.destroy();
  alert("âœ… Database berhasil direset");
  render();
}

/* RENDER */
function render(){
  const log=document.getElementById("log");
  log.innerHTML="";
  let wait=0,done=0;

  data.forEach((d,i)=>{
    if(startViewDate){
      const t=new Date(d.tgl.split("/").reverse().join("-"));
      const s=new Date(startViewDate.split("/").reverse().join("-"));
      if(t<s) return;
    }
    if(d.status==="Menunggu") wait++;
    if(d.status==="Selesai") done++;

    log.innerHTML+=`
    <tr>
      <td>${d.no}</td>
      <td>${d.tgl}</td>
      <td>${d.jam}</td>
      <td><span class="badge ${d.status==="Menunggu"?"wait":"done"}">${d.status}</span></td>
      <td>${d.status==="Menunggu"
        ? `<button class="btn-small btn-green" onclick="selesaikan(${i})">Selesai</button>`
        : "-"}</td>
    </tr>`;
  });

  document.getElementById("total").innerText=data.filter(d=>d.tgl===today).length;
  document.getElementById("waiting").innerText=wait;
  document.getElementById("done").innerText=done;
}

/* STATISTIK */
function toggleStat(){
  const box=statistikBox;
  box.style.display=box.style.display==="none"?"block":"none";
}

function applyFilterBulanan(){
  const val=filterBulan.value;
  if(!val) return;
  const [y,m]=val.split("-").map(Number);
  const days=new Date(y,m,0).getDate();
  const perHari={};
  for(let i=1;i<=days;i++) perHari[i]=0;

  data.forEach(d=>{
    const [dd,mm,yy]=d.tgl.split("/").map(Number);
    if(mm===m && yy===y) perHari[dd]++;
  });

  if(window.chart) window.chart.destroy();
  window.chart=new Chart(chartPengunjung,{
    type:"bar",
    data:{labels:Object.keys(perHari),
      datasets:[{data:Object.values(perHari),backgroundColor:"#1d4ed8"}]},
    options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{precision:0}}}}
  });
}

/* CETAK TIKET MINI */
function cetakTiket(t){
  const w=window.open("","","width=240,height=400");
  w.document.write(`
  <style>
  @page{margin:0;size:58mm auto}
  body{text-align:center;font-family:Arial;font-size:12px;margin:0;padding:8px}
  h1{font-size:48px;margin:6px 0}
  </style>
  <body onload="window.print()">
    <img src="logo-bps.png" style="height:32px"><br>
    <strong>PST BPS Kab. Belitung</strong>
    <div>Nomor Antrian</div>
    <h1>${t.no}</h1>
    <div>${t.tgl}<br>${t.jam}</div>
  </body>`);
  w.document.close();
}

render();
</script>

</body>
</html>
